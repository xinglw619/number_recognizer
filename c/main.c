#include <stdio.h>
#include <stdint.h>
#define _NO_OLDNAMES
#include <stdlib.h>

#include "params16bit.h"
#include "net.h" 
#include <math.h>


typedef int16_t data_t;
typedef int int32_t;

#define IMG_CH 1
#define IMG_SIZE 28

//#define SCALE_FACTOR 255.0 
//#define SCALE_FACTOR 32767.0  // 2^15 - 1
// #define SCALE_FACTOR 1023      // 2^10 - 1
#define SCALE_FACTOR 1023      //2^8 - 1

float img1[IMG_CH][IMG_SIZE][IMG_SIZE] = {
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.003922, 0.003922, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.031373, 0.090196, 0.141176, 0.152941, 0.168627, 0.301961, 0.337255, 0.282353, 0.125490, 0.007843, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.027451, 0.211765, 0.411765, 0.498039, 0.529412, 0.533333, 0.537255, 0.549020, 0.552941, 0.552941, 0.490196, 0.215686, 0.039216, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.019608, 0.290196, 0.533333, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.549020, 0.552941, 0.552941, 0.552941, 0.533333, 0.356863, 0.035294, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.105882, 0.501961, 0.552941, 0.552941, 0.552941, 0.537255, 0.509804, 0.541176, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.525490, 0.133333, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.203922, 0.545098, 0.552941, 0.552941, 0.549020, 0.321569, 0.101961, 0.282353, 0.529412, 0.552941, 0.552941, 0.552941, 0.552941, 0.537255, 0.156863, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.282353, 0.552941, 0.552941, 0.552941, 0.498039, 0.109804, 0.000000, 0.027451, 0.184314, 0.329412, 0.533333, 0.552941, 0.552941, 0.525490, 0.137255, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.003922, 0.333333, 0.537255, 0.533333, 0.474510, 0.196078, 0.011765, 0.000000, 0.000000, 0.125490, 0.400000, 0.541176, 0.552941, 0.552941, 0.411765, 0.039216, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.180392, 0.231373, 0.227451, 0.168627, 0.003922, 0.000000, 0.000000, 0.007843, 0.278431, 0.552941, 0.552941, 0.552941, 0.537255, 0.200000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.125490, 0.486275, 0.552941, 0.552941, 0.552941, 0.407843, 0.043137, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.105882, 0.439216, 0.552941, 0.552941, 0.552941, 0.505882, 0.145098, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.019608, 0.180392, 0.443137, 0.549020, 0.552941, 0.552941, 0.541176, 0.282353, 0.011765, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.188235, 0.521569, 0.552941, 0.552941, 0.552941, 0.549020, 0.380392, 0.047059, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.003922, 0.101961, 0.439216, 0.552941, 0.552941, 0.552941, 0.552941, 0.447059, 0.090196, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.047059, 0.211765, 0.450980, 0.549020, 0.549020, 0.552941, 0.552941, 0.501961, 0.160784, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.094118, 0.133333, 0.341176, 0.537255, 0.552941, 0.552941, 0.549020, 0.552941, 0.552941, 0.443137, 0.282353, 0.266667, 0.223529, 0.188235, 0.156863, 0.094118, 0.062745, 0.062745, 0.031373, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.031373, 0.396078, 0.521569, 0.537255, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.549020, 0.545098, 0.537255, 0.494118, 0.474510, 0.474510, 0.270588, 0.003922, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.062745, 0.474510, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.552941, 0.474510, 0.137255, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.027451, 0.411765, 0.552941, 0.552941, 0.552941, 0.545098, 0.541176, 0.529412, 0.521569, 0.521569, 0.521569, 0.501961, 0.494118, 0.494118, 0.478431, 0.458824, 0.458824, 0.439216, 0.207843, 0.003922, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.160784, 0.482353, 0.505882, 0.423529, 0.286275, 0.200000, 0.180392, 0.145098, 0.125490, 0.125490, 0.121569, 0.090196, 0.082353, 0.082353, 0.066667, 0.047059, 0.047059, 0.039216, 0.007843, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.090196, 0.180392, 0.098039, 0.035294, 0.003922, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000,
};

void float_array_to_fixed(float input[], int16_t output[], int size) {
    for (int i = 0; i < size; ++i) {
        // 范围映射和舍入
        float scaledValue = input[i] * SCALE_FACTOR ;

        // 确保不超过16位定点数的范围
        scaledValue = (scaledValue > SCALE_FACTOR) ? SCALE_FACTOR : scaledValue;
        scaledValue = (scaledValue < -SCALE_FACTOR) ? -SCALE_FACTOR : scaledValue;

        // 赋值给16位整数数组
        output[i] = (int16_t)scaledValue;
    }
}


int main(void)
{
	//对输入图像进行定点化转化
	int16_t img[IMG_CH][IMG_SIZE][IMG_SIZE];
	float_array_to_fixed(&img1[0][0][0], &img[0][0][0], IMG_CH * IMG_SIZE * IMG_SIZE);

	printf("Fixed-point values:\n");
	for (int i = 0; i < IMG_CH; ++i) {
        for (int j = 0; j < IMG_SIZE; ++j) {
            for (int k = 0; k < IMG_SIZE; ++k) {
                // 打印转换后的定点数
                printf("%d, ", img[i][j][k]);
            }
            printf("\n");
        }
        printf("\n");
    }



	// 第一次卷积（参数没有直接写数字，写的宏变量方便阅读，后面的将直接写数字）
	data_t dout1[CONV1_COUT][IMG_SIZE - CONV1_SIZE + 1][IMG_SIZE - CONV1_SIZE + 1] = {0};
	int shape1[4] = {CONV1_COUT, CONV1_CIN, CONV1_SIZE, CONV1_SIZE};
	conv2d_f32(&dout1[0][0][0], &img[0][0][0], IMG_SIZE, IMG_SIZE, &conv1_weight[0][0][0][0], &conv1_bias[0], shape1);
	// for(int i=0; i<32; i++) {
	// 	for(int j=0; j<24; j++) {
	// 		for(int k=0; k<24; k++) {
	// 			printf("%d,", dout1[i][j][k]);
	// 		}
	// 		printf("\n");
	// 	}
	// 	printf("\n");
	// }

	// ReLU
	relu(&dout1[0][0][0],&dout1[0][0][0], 32 * 24 * 24);
	// for(int i=0; i<32; i++) {
	// 	for(int j=0; j<24; j++) {
	// 		for(int k=0; k<24; k++) {
	// 			printf("%d,", dout1[i][j][k]);
	// 		}
	// 		printf("\n");
	// 	}
	// 	printf("\n");
	// }

	// 最大池化
	data_t dout2[32][12][12] = {0};
	maxpool2d(&dout2[0][0][0], &dout1[0][0][0], 24, 24, 32, 2);
	// for(int i=0; i<32; i++) {
	// 	for(int j=0; j<12; j++) {
	// 		for(int k=0; k<12; k++) {
	// 			printf("%d,", dout2[i][j][k]);
	// 		}
	// 		printf("\n");
	// 	}
	// 	printf("\n");
	// }

	// 第二次卷积
	data_t dout3[CONV2_COUT][8][8] = {0};
	int shape2[4] = {CONV2_COUT, CONV2_CIN, CONV2_SIZE, CONV2_SIZE};
	conv2d_f32(&dout3[0][0][0], &dout2[0][0][0], 12, 12,&conv2_weight[0][0][0][0], &conv2_bias[0], shape2);
	// for(int i=0; i<32; i++) {
	// 	for(int j=0; j<12; j++) {
	// 		for(int k=0; k<12; k++) {
	// 			printf("%d,", dout3[i][j][k]);
	// 		}
	// 		printf("\n");
	// 	}
	// 	printf("\n");
	// }


	// ReLU激活
	relu(&dout3[0][0][0], &dout3[0][0][0], 32 * 8 * 8);
	// for(int i=0; i<32; i++) {
	// 	for(int j=0; j<8; j++) {
	// 		for(int k=0; k<8; k++) {
	// 			printf("%d,", dout3[i][j][k]);
	// 		}
	// 		printf("\n");
	// 	}
	// 	printf("\n");
	// }

	// 最大池化 
	data_t dout4[CONV2_COUT][4][4] = {0};
	maxpool2d(&dout4[0][0][0], &dout3[0][0][0], 8, 8, CONV2_COUT, MAXPOOL_SIZE);
	// for(int i=0; i<32; i++) {
	// 	for(int j=0; j<4; j++) {
	// 		for(int k=0; k<4; k++) {
	// 			printf("%d,", dout4[i][j][k]);
	// 		}
	// 		printf("\n");
	// 	}
	// 	printf("\n");
	// }
	
	// 转向量
	data_t dout5[512] = {0};
	flatten(dout5, &dout4[0][0][0], 512, 4, CONV2_COUT);
	// for(int i = 0; i < 512; i++) {
	// 	printf("%d,", dout5[i]);
	// }
	
	// 全连接
	data_t dout6[1024] = {0};
	int shape3[2] = {1024, 512};
	fc_32(dout6, dout5, &linear1_weight[0][0], linear1_bias, shape3);
	// for(int i = 0; i < 1024; i++) {
	// 	printf("%d,", dout6[i]);
	// }

	// ReLU激活 
	relu(dout6, dout6, 1024);
	
	// 全连接 
	data_t dout7[10] = {0};
	int shape4[2] = {10, 1024};
	fc_32(dout7, dout6, &linear2_weight[0][0], linear2_bias, shape4);
	
	int ans = 0;  // 答案
	data_t max = -32768;;  // 定一个足够小的值，用来找最大值

	printf("计算结果为：");
	for(int i = 0; i < 10; i++)
	{
		printf("%d ", dout7[i]);
		if (dout7[i] > max)
		{
			max = dout7[i];
			ans = i;
		}
	}
	printf("\n识别结果为:  %d\n", ans);
	
	return 0;
}
